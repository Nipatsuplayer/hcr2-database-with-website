<!DOCTYPE html>
<html>
<head>
    <title>Hill Climb Racing 2 Records</title>
    <script>
        let allData = []; 
        let currentDataType = ''; 
        let allPlayers = []; // cached players for filtering and auto-fill

        
        function fetchStats() {
            const statsContainer = document.getElementById('stats-container');
            const dataContainer = document.getElementById('data-container');
            const filterContainer = document.getElementById('filter-container');

            if (currentDataType === 'stats' && statsContainer.style.display === 'block') {
                statsContainer.style.display = 'none';
                currentDataType = '';
                return;
            }

            currentDataType = 'stats';
            dataContainer.style.display = 'none';
            if (filterContainer) filterContainer.style.display = 'none';
            statsContainer.style.display = 'block';

            fetch('load_data.php?type=records')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        statsContainer.innerHTML = '<p style="color:red;">' + data.error + '</p>';
                    } else {
                        displayStats(data);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    statsContainer.innerHTML = '<p style="color:red;">Error fetching stats data from server.</p>';
                });
        }

        function displayStats(data) {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = '<h2>Detailed Statistics</h2>';

            // Vehicle Rankings
            const vehicleStats = {};
            data.forEach(record => {
                if (!vehicleStats[record.vehicle_name]) {
                    vehicleStats[record.vehicle_name] = 0;
                }
                vehicleStats[record.vehicle_name] += record.distance;
            });

            const sortedVehicles = Object.entries(vehicleStats)
                .sort((a, b) => b[1] - a[1]);

            let vehicleHTML = '<div class="stats-section"><h3>Vehicle Rankings by Total Distance</h3><table>';
            vehicleHTML += '<tr><th>Rank</th><th>Vehicle Name</th><th>Total Distance</th></tr>';
            sortedVehicles.forEach((vehicle, index) => {
                vehicleHTML += `<tr><td>${index + 1}</td><td>${vehicle[0]}</td><td>${vehicle[1]}</td></tr>`;
            });
            vehicleHTML += '</table></div>';
            statsContainer.innerHTML += vehicleHTML;

            // Top 10 Players by Record Count
            const playerRecords = {};
            data.forEach(record => {
                playerRecords[record.player_name] = (playerRecords[record.player_name] || 0) + 1;
            });

            const sortedPlayers = Object.entries(playerRecords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            let playersHTML = '<div class="stats-section"><h3>Top 10 Players by Record Count</h3>';
            playersHTML += '<div class="chart-container">';
            
            const maxRecords = Math.max(...sortedPlayers.map(p => p[1]));
            sortedPlayers.forEach((player, index) => {
                const barWidth = (player[1] / maxRecords) * 100;
                playersHTML += `
                    <div class="chart-bar">
                        <span class="player-rank">${index + 1}.</span>
                        <span class="player-name">${player[0]}</span>
                        <div class="bar" style="width: ${barWidth}%;">
                            <span class="bar-value">${player[1]}</span>
                        </div>
                    </div>
                `;
            });
            
            playersHTML += '</div></div>';
            statsContainer.innerHTML += playersHTML;

            // Map Statistics
            const mapStats = {};
            const mapRecordCount = {};
            data.forEach(record => {
                if (!mapStats[record.map_name]) {
                    mapStats[record.map_name] = { distance: 0, count: 0 };
                }
                mapStats[record.map_name].distance += record.distance;
                mapStats[record.map_name].count += 1;
            });

            const sortedMaps = Object.entries(mapStats)
                .sort((a, b) => b[1].distance - a[1].distance);

            let mapHTML = '<div class="stats-section"><h3>Map Statistics</h3><table>';
            mapHTML += '<tr><th>Map Name</th><th>Total Records</th><th>Total Distance</th><th>Average Distance</th></tr>';
            sortedMaps.forEach(map => {
                const avgDistance = (map[1].distance / map[1].count).toFixed(2);
                mapHTML += `<tr><td>${map[0]}</td><td>${map[1].count}</td><td>${map[1].distance}</td><td>${avgDistance}</td></tr>`;
            });
            mapHTML += '</table></div>';
            statsContainer.innerHTML += mapHTML;

            // Overall Statistics
            const totalRecords = data.length;
            const totalDistance = data.reduce((sum, record) => sum + record.distance, 0);
            const avgDistance = (totalDistance / totalRecords).toFixed(2);
            const uniquePlayers = new Set(data.map(r => r.player_name)).size;
            const uniqueVehicles = new Set(data.map(r => r.vehicle_name)).size;
            const uniqueMaps = new Set(data.map(r => r.map_name)).size;

            let overallHTML = '<div class="stats-section"><h3>Overall Statistics</h3><div class="overall-stats">';
            overallHTML += `<div class="stat-box"><strong>Total Records:</strong> ${totalRecords}</div>`;
            overallHTML += `<div class="stat-box"><strong>Total Distance:</strong> ${totalDistance}</div>`;
            overallHTML += `<div class="stat-box"><strong>Average Distance:</strong> ${avgDistance}</div>`;
            overallHTML += `<div class="stat-box"><strong>Unique Players:</strong> ${uniquePlayers}</div>`;
            overallHTML += `<div class="stat-box"><strong>Unique Vehicles:</strong> ${uniqueVehicles}</div>`;
            overallHTML += `<div class="stat-box"><strong>Unique Maps:</strong> ${uniqueMaps}</div>`;
            overallHTML += '</div></div>';
            statsContainer.innerHTML += overallHTML;
        }

        function filterPlayers() {
            const query = document.getElementById('player-filter').value.toLowerCase();
            const select = document.getElementById('player-select');
            // rebuild options from allPlayers matching query
            select.innerHTML = '<option value="">Select an Existing Player</option>';
            allPlayers
                .filter(p => p.namePlayer.toLowerCase().includes(query))
                .forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.idPlayer;
                    option.textContent = p.namePlayer;
                    select.appendChild(option);
                });
            // trigger selection handler in case an option is preselected
            handlePlayerSelection();
        }

        function handlePlayerSelection() {
            const select = document.getElementById('player-select');
            const countryInput = document.getElementById('country-input');
            const playerId = select.value;
            const newPlayerInput = document.getElementById('new-player-input');

            if (playerId) {
                // fill country from cached players and disable editing
                const player = allPlayers.find(p => String(p.idPlayer) === String(playerId));
                if (player) {
                    countryInput.value = player.country || '';
                    countryInput.disabled = true;
                } else {
                    countryInput.value = '';
                    countryInput.disabled = false;
                }
                // clear new player field when existing player chosen
                newPlayerInput.value = '';
            } else {
                // no existing player selected -> enable country for new player
                countryInput.value = '';
                countryInput.disabled = false;
            }
        }

        function fetchData(dataType) {
            const container = document.getElementById('data-container');
            const filterContainer = document.getElementById('filter-container');
            const statsContainer = document.getElementById('stats-container');
            statsContainer.style.display = 'none';

            if (currentDataType === dataType && container.style.display === 'block') {
                
                container.style.display = 'none';
                if (filterContainer) filterContainer.style.display = 'none'; 
                currentDataType = ''; 
                return;
            }

            currentDataType = dataType; 
            container.style.display = 'block'; 

            
            if (dataType === 'records') {
                if (filterContainer) filterContainer.style.display = 'flex'; 
            } else {
                if (filterContainer) filterContainer.style.display = 'none'; 
            }

            fetch('load_data.php?type=' + dataType)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        container.innerHTML = '<p style="color:red;">' + data.error + '</p>';
                    } else {
                        allData = data; 
                        displayData(data, dataType);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    container.innerHTML = '<p style="color:red;">Error fetching data from server.</p>';
                });
        }

        
        function fetchSummary() {
            fetch('load_data.php?type=records')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        document.getElementById('summary-container').innerHTML = '<p style="color:red;">' + data.error + '</p>';
                    } else {
                        displaySummary(data);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('summary-container').innerHTML = '<p style="color:red;">Error fetching summary data from server.</p>';
                });
        }

        
        function displaySummary(data) {
            const summaryContainer = document.getElementById('summary-container');
            const playerRecords = {};
            const vehicleDistances = {};

            data.forEach(record => {
                
                playerRecords[record.player_name] = (playerRecords[record.player_name] || 0) + 1;

                
                vehicleDistances[record.vehicle_name] = (vehicleDistances[record.vehicle_name] || 0) + record.distance;
            });

            
            const bestPlayer = Object.keys(playerRecords).reduce((a, b) => playerRecords[a] > playerRecords[b] ? a : b);
            const bestVehicle = Object.keys(vehicleDistances).reduce((a, b) => vehicleDistances[a] > vehicleDistances[b] ? a : b);

            summaryContainer.innerHTML = `
                <h2>Summary</h2>
                <div class="summary-box">
                    <p><strong>Best Player:</strong> ${bestPlayer} (${playerRecords[bestPlayer]} records)</p>
                    <p><strong>Best Vehicle:</strong> ${bestVehicle} (${vehicleDistances[bestVehicle]} total distance)</p>
                </div>
            `;
        }

        
        function displayData(data, dataType) {
            const container = document.getElementById('data-container');
            container.innerHTML = ''; 

            
            if (dataType === 'records' && !document.getElementById('filter-container')) {
                addSearchAndFilter();
            }

            container.innerHTML += '<h2>' + dataType.toUpperCase() + '</h2>'; 

            if (data.length === 0) {
                container.innerHTML += '<p>No data available.</p>';
                return;
            }

            let tableHTML = '<table>';
            if (dataType === 'maps') {
                tableHTML += '<tr><th>Map ID</th><th>Map Name</th></tr>';
                data.forEach(item => {
                    tableHTML += `<tr><td>${item.idMap}</td><td>${item.nameMap}</td></tr>`;
                });
            } else if (dataType === 'vehicles') {
                tableHTML += '<tr><th>Vehicle ID</th><th>Vehicle Name</th></tr>';
                data.forEach(item => {
                    tableHTML += `<tr><td>${item.idVehicle}</td><td>${item.nameVehicle}</td></tr>`;
                });
            } else if (dataType === 'players') {
                tableHTML += '<tr><th>Player ID</th><th>Player Name</th><th>Country</th></tr>';
                data.forEach(item => {
                    tableHTML += `<tr><td>${item.idPlayer}</td><td>${item.namePlayer}</td><td>${item.country}</td></tr>`;
                });
            } else if (dataType === 'records') {
                tableHTML += '<tr><th>Distance</th><th>Map Name</th><th>Vehicle Name</th><th>Player Name</th><th>Player Country</th></tr>';
                data.forEach(item => {
                    tableHTML += `<tr>
                                    <td>${item.distance}</td>
                                    <td>${item.map_name}</td>
                                    <td>${item.vehicle_name}</td>
                                    <td>${item.player_name}</td>
                                    <td>${item.player_country}</td>
                                  </tr>`;
                });
            }
            tableHTML += '</table>';
            container.innerHTML += tableHTML;
        }

        
        function addSearchAndFilter() {
            const container = document.getElementById('data-container');
            const searchHTML = `
                <div id="filter-container" class="filter-container">
                    <input type="text" id="search-bar" placeholder="Search by player, map, or vehicle..." oninput="filterRecords()">
                    <select id="map-filter" onchange="filterRecords()">
                        <option value="">Filter by Map</option>
                        ${[...new Set(allData.map(record => record.map_name))].map(map => `<option value="${map}">${map}</option>`).join('')}
                    </select>
                    <select id="vehicle-filter" onchange="filterRecords()">
                        <option value="">Filter by Vehicle</option>
                        ${[...new Set(allData.map(record => record.vehicle_name))].map(vehicle => `<option value="${vehicle}">${vehicle}</option>`).join('')}
                    </select>
                </div>
            `;
            container.insertAdjacentHTML('beforebegin', searchHTML);
        }

        
        function filterRecords() {
            const searchQuery = document.getElementById('search-bar').value.toLowerCase();
            const mapFilter = document.getElementById('map-filter').value;
            const vehicleFilter = document.getElementById('vehicle-filter').value;

            const filteredData = allData.filter(record => {
                const matchesSearch = record.player_name.toLowerCase().includes(searchQuery) ||
                                      record.map_name.toLowerCase().includes(searchQuery) ||
                                      record.vehicle_name.toLowerCase().includes(searchQuery);
                const matchesMap = !mapFilter || record.map_name === mapFilter;
                const matchesVehicle = !vehicleFilter || record.vehicle_name === vehicleFilter;

                return matchesSearch && matchesMap && matchesVehicle;
            });

            displayData(filteredData, currentDataType);
        }

        
        window.onload = () => {
            fetchSummary();
            populateFormOptions();
            populateDeleteOptions();
        };

        
        function populateFormOptions() {
            fetch('load_data.php?type=maps')
                .then(response => response.json())
                .then(data => {
                    const mapSelect = document.getElementById('map-select');
                    mapSelect.innerHTML = '<option value="">Select a Map</option>';
                    data.forEach(map => {
                        const option = document.createElement('option');
                        option.value = map.idMap;
                        option.textContent = map.nameMap;
                        mapSelect.appendChild(option);
                    });
                });

            fetch('load_data.php?type=vehicles')
                .then(response => response.json())
                .then(data => {
                    const vehicleSelect = document.getElementById('vehicle-select');
                    vehicleSelect.innerHTML = '<option value="">Select a Vehicle</option>';
                    data.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.idVehicle;
                        option.textContent = vehicle.nameVehicle;
                        vehicleSelect.appendChild(option);
                    });
                });

            fetch('load_data.php?type=players')
                .then(response => response.json())
                .then(data => {
                    const playerSelect = document.getElementById('player-select');
                    allPlayers = data || [];
                    playerSelect.innerHTML = '<option value="">Select an Existing Player</option>';
                    allPlayers.forEach(player => {
                        const option = document.createElement('option');
                        option.value = player.idPlayer;
                        option.textContent = player.namePlayer;
                        playerSelect.appendChild(option);
                    });
                });
        }

        
        function submitRecord(event) {
            event.preventDefault();

            const mapId = document.getElementById('map-select').value;
            const vehicleId = document.getElementById('vehicle-select').value;
            const distance = document.getElementById('distance-input').value;
            const playerId = document.getElementById('player-select').value;
            const newPlayerName = document.getElementById('new-player-input').value;
            const country = document.getElementById('country-input').value;

            if (!playerId && !newPlayerName) {
                document.getElementById('form-message').textContent = 'Please select an existing player or add a new one.';
                document.getElementById('form-message').style.color = 'red';
                return;
            }

            // If adding a new player, country must be provided
            if (!playerId && newPlayerName && !country) {
                document.getElementById('form-message').textContent = 'Please provide a country for the new player.';
                document.getElementById('form-message').style.color = 'red';
                return;
            }

            // If an existing player is selected, ignore newPlayerName and send only playerId
            const formData = playerId ? {
                mapId,
                vehicleId,
                distance,
                playerId
            } : {
                mapId,
                vehicleId,
                distance,
                playerId: null,
                newPlayerName,
                country
            };

            fetch('submit_record.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('form-message').textContent = 'Record submitted successfully!';
                    document.getElementById('form-message').style.color = 'green';
                    document.getElementById('record-form').reset();

                    // Refresh the delete record dropdown and player lists (to include newly created player)
                    populateDeleteOptions();
                    populateFormOptions();
                } else {
                    document.getElementById('form-message').textContent = 'Error: ' + data.error;
                    document.getElementById('form-message').style.color = 'red';
                }
            })
            .catch(error => {
                document.getElementById('form-message').textContent = 'Error submitting record.';
                document.getElementById('form-message').style.color = 'red';
            });
        }

        
        function populateDeleteOptions() {
            fetch('load_data.php?type=records')
                .then(response => response.json())
                .then(data => {
                    const recordSelect = document.getElementById('record-select');
                    recordSelect.innerHTML = '<option value="">Select a Record</option>'; // Clear existing options
                    data.forEach(record => {
                        const option = document.createElement('option');
                        option.value = record.idRecord; // Assuming `idRecord` is the unique identifier for records
                        option.textContent = `${record.distance} - ${record.map_name} - ${record.vehicle_name} - ${record.player_name}`;
                        recordSelect.appendChild(option);
                    });
                });
        }

        
        function deleteRecord(event) {
            event.preventDefault();

            const recordId = document.getElementById('record-select').value;

            if (!recordId) {
                document.getElementById('delete-message').textContent = 'Please select a record to delete.';
                document.getElementById('delete-message').style.color = 'red';
                return;
            }

            fetch('delete_record.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recordId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('delete-message').textContent = 'Record deleted successfully!';
                    document.getElementById('delete-message').style.color = 'green';
                    populateDeleteOptions(); 
                } else {
                    document.getElementById('delete-message').textContent = 'Error: ' + data.error;
                    document.getElementById('delete-message').style.color = 'red';
                }
            })
            .catch(error => {
                document.getElementById('delete-message').textContent = 'Error deleting record.';
                document.getElementById('delete-message').style.color = 'red';
            });
        }
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        color: #333;
      }
      header {
        background-color: #007bff;
        color: white;
        padding: 20px;
        text-align: center;
      }
      header h1 {
        margin: 0;
      }
      .header-buttons {
        margin-top: 10px;
      }
      .header-buttons button {
        margin: 5px;
        padding: 10px 20px;
        font-size: 16px;
        color: #fff;
        background-color: #0056b3;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .header-buttons button:hover {
        background-color: #003d80;
      }
      main {
        padding: 20px;
        text-align: center;
      }
      h2 {
        text-align: center;
        margin-top: 20px;
      }
      .summary-box {
        background-color: #ffeb3b;
        padding: 20px;
        margin: 20px auto;
        width: 80%;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-size: 18px;
      }
      .filter-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }
      #search-bar, select {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      table {
        border-collapse: collapse;
        width: 90%;
        margin: 20px auto;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tr:hover {
        background-color: #f1f1f1;
      }
      .form-container {
        background-color: #f9f9f9;
        padding: 20px;
        margin: 20px auto;
        width: 80%;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .form-container h2 {
        margin-bottom: 15px;
      }
      .form-container label {
        font-weight: bold;
      }
      .form-container input, .form-container select, .form-container button {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .form-container button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      .form-container button:hover {
        background-color: #0056b3;
      }
      #data-container {
        display: none; 
      }
      #stats-container {
        display: none;
      }
      .stats-section {
        margin: 30px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        width: 90%;
      }
      .stats-section h3 {
        color: #007bff;
        margin-top: 0;
      }
      .chart-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .chart-bar {
        display: grid;
        grid-template-columns: 35px 140px 1fr;
        gap: 10px;
        align-items: center;
        width: 100%;
      }
      .player-rank {
        font-weight: bold;
        text-align: right;
      }
      .player-name {
        text-align: right;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .bar {
        height: 30px;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        min-width: 50px;
      }
      .bar-value {
        color: white;
        font-weight: bold;
        font-size: 14px;
      }
      .overall-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .stat-box {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .stat-box strong {
        display: block;
        font-size: 14px;
        opacity: 0.9;
      }
    </style>
</head>
<body>
    <header>
        <h1>Hill Climb Racing 2 Adventure Records</h1>
        <div class="header-buttons">
            <button onclick="fetchData('maps')">Get Maps</button>
            <button onclick="fetchData('vehicles')">Get Vehicles</button>
            <button onclick="fetchData('players')">Get Players</button>
            <button onclick="fetchData('records')">Get Records</button>
            <button onclick="fetchStats()">Stats</button>
        </div>
    </header>
    <main>
        <div id="summary-container"></div>
        <div id="stats-container"></div>
        <div id="data-container"></div>
        <div id="record-form-container" class="form-container">
            <h2>Submit a New Record</h2>
            <form id="record-form" onsubmit="submitRecord(event)">
                <label for="map-select">Map:</label>
                <select id="map-select" required>
                    <option value="">Select a Map</option>
                </select>
                <br><br>
                <label for="vehicle-select">Vehicle:</label>
                <select id="vehicle-select" required>
                    <option value="">Select a Vehicle</option>
                </select>
                <br><br>
                <label for="distance-input">Distance:</label>
                <input type="number" id="distance-input" placeholder="Enter distance" required>
                <br><br>
                <label for="player-select">Player:</label>
                <input type="text" id="player-filter" placeholder="Filter players..." oninput="filterPlayers()">
                <select id="player-select" onchange="handlePlayerSelection()">
                    <option value="">Select an Existing Player</option>
                </select>
                <br><br>
                <label for="new-player-input">Or Add New Player:</label>
                <input type="text" id="new-player-input" placeholder="Enter new player name">
                <br><br>
                <label for="country-input">Country:</label>
                <input type="text" id="country-input" placeholder="Enter country">
                <br><br>
                <button type="submit">Submit Record</button>
            </form>
            <p id="form-message" style="color: green;"></p>
        </div>
        <div id="delete-form-container" class="form-container">
            <h2>Delete a Record</h2>
            <form id="delete-form" onsubmit="deleteRecord(event)">
                <label for="record-select">Record:</label>
                <select id="record-select" required>
                    <option value="">Select a Record</option>
                </select>
                <br><br>
                <button type="submit">Delete Record</button>
            </form>
            <p id="delete-message" style="color: green;"></p>
        </div>
    </main>
</body>
</html>
